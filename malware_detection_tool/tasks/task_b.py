import os
from datetime import datetime
from utils.hashing import create_hashes
from utils.file_utils import quarantine_file
from tasks.task_a import detect_malware  # Ensure this import is correct based on your setup

def scan_directory(directory, signatures, log_file):
    print(f"Scanning directory: {directory}")
    with open(log_file, 'w') as log:
        log.write("Scanning Report\n")
        log.write(f"Scan started at: {datetime.now()}\n\n")

        for root, _, files in os.walk(directory):
            for file in files:
                file_path = os.path.join(root, file)
                print(f"Processing file: {file_path}")  # Debug log to track each file

                with open(file_path, 'rb') as f:
                    data = f.read().decode(errors='ignore')

                # Calculate hashes for the file content
                md5_hash, sha256_hash = create_hashes(data)
                print(f"File hashes - MD5: {md5_hash}, SHA256: {sha256_hash}")  # Debug log

                # Check if hashes match any known malware signatures
                if detect_malware(signatures, data):
                    log.write(f"{datetime.now()} - Malware detected: {file} in {file_path}\n")
                    quarantine_file(file_path)
                    print(f"Quarantined file: {file_path}")  # Confirmation for each quarantine action
                else:
                    log.write(f"{datetime.now()} - File {file} is clean.\n")
                    print(f"File {file} is clean.")  # Debug confirmation for clean files

        log.write(f"\nScan completed at: {datetime.now()}\n")
        print(f"Scan completed. Log saved to {log_file}")
